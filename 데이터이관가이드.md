# 📋 데이터베이스 이관 가이드

계약관리시스템의 데이터베이스를 새로운 환경으로 이관하는 방법을 안내합니다.

## 🚀 빠른 시작 (권장)

가장 간단한 방법으로 데이터베이스를 설정하고 기본 데이터를 생성합니다.

### 1단계: 빠른 설정 실행

```bash
# 데이터베이스 연결 및 기본 데이터 생성
node quick-migrate.js
```

이 스크립트는 다음 작업을 수행합니다:
- ✅ 데이터베이스 연결 테스트
- ✅ 테이블 생성/동기화 (기존 데이터 유지)
- ✅ 기본 마스터 데이터 생성 (부서, 예산, 공급업체, 계약방법)
- ✅ 현재 데이터 현황 출력

## 🔄 전체 데이터 이관 (고급)

기존 데이터베이스에서 새 데이터베이스로 모든 데이터를 이관하는 경우 사용합니다.

### 1단계: 환경 설정

```bash
# 이관 설정 파일 복사
cp migration.env.example .env.migration
```

`.env.migration` 파일을 편집하여 데이터베이스 정보를 입력:

```env
# 소스 데이터베이스 (기존 DB)
SOURCE_DB_NAME=기존_데이터베이스명
SOURCE_DB_USERNAME=사용자명
SOURCE_DB_PASSWORD=비밀번호
SOURCE_DB_HOST=localhost
SOURCE_DB_PORT=5432

# 타겟 데이터베이스 (새 DB)
DB_NAME=contract_management
DB_USERNAME=postgres
DB_PASSWORD=meritz123!
DB_HOST=localhost
DB_PORT=5432
```

### 2단계: 전체 데이터 이관 실행

```bash
# 백업 생성과 함께 이관
node migrate-data.js --backup

# 백업 없이 이관
node migrate-data.js
```

## 📊 이관되는 데이터

다음 순서로 테이블 데이터가 이관됩니다:

1. **departments** - 부서 정보
2. **budgets** - 예산 정보
3. **suppliers** - 공급업체 정보
4. **contract_methods** - 계약방법
5. **cost_departments** - 비용귀속부서
6. **proposals** - 품의서
7. **request_departments** - 요청부서
8. **purchase_items** - 구매품목
9. **purchase_item_cost_allocations** - 구매품목 비용분배
10. **service_items** - 용역품목
11. **contracts** - 계약서
12. **approval_lines** - 결재라인
13. **proposal_histories** - 품의서 이력

## 🛠️ 수동 데이터베이스 설정

### PostgreSQL 데이터베이스 생성

```sql
-- 데이터베이스 생성
CREATE DATABASE contract_management;

-- 사용자 권한 부여
GRANT ALL PRIVILEGES ON DATABASE contract_management TO postgres;
```

### 테이블 생성

```bash
# 모델 기반 테이블 생성
node sync-db.js
```

### 기본 데이터 생성

```bash
# 샘플 데이터 생성
node create-basic-samples.js
```

## 🔍 문제 해결

### 연결 오류

```bash
# 데이터베이스 연결 테스트
node -e "
const { Sequelize } = require('sequelize');
require('dotenv').config();
const sequelize = new Sequelize(
  process.env.DB_NAME || 'contract_management',
  process.env.DB_USERNAME || 'postgres', 
  process.env.DB_PASSWORD || 'meritz123!',
  {
    host: process.env.DB_HOST || 'localhost',
    port: process.env.DB_PORT || 5432,
    dialect: 'postgres'
  }
);
sequelize.authenticate()
  .then(() => console.log('✅ 연결 성공'))
  .catch(err => console.log('❌ 연결 실패:', err.message));
"
```

### 테이블 확인

```bash
# 현재 테이블 목록 확인
node check-tables.js
```

### 데이터 현황 확인

```bash
# 각 테이블의 데이터 개수 확인
node check-data.js
```

## 📝 주의사항

1. **백업 필수**: 이관 전 반드시 기존 데이터를 백업하세요.
2. **권한 확인**: PostgreSQL 사용자에게 적절한 권한이 있는지 확인하세요.
3. **포트 확인**: PostgreSQL 서비스가 실행 중이고 포트가 열려있는지 확인하세요.
4. **환경변수**: `.env` 파일의 데이터베이스 설정이 올바른지 확인하세요.

## 🆘 도움말

### 자주 발생하는 오류

**1. "database does not exist"**
```sql
CREATE DATABASE contract_management;
```

**2. "password authentication failed"**
- `.env` 파일의 비밀번호 확인
- PostgreSQL 사용자 권한 확인

**3. "relation does not exist"**
```bash
# 테이블 재생성
node sync-db.js
```

**4. "port 5432 failed: Connection refused"**
- PostgreSQL 서비스 시작: `sudo service postgresql start`
- 포트 확인: `netstat -an | grep 5432`

### 로그 확인

이관 과정에서 발생하는 모든 로그는 콘솔에 출력됩니다:
- ✅ 성공: 녹색 체크마크
- ❌ 오류: 빨간색 X 마크  
- 📋 정보: 파란색 클립보드 마크

## 📞 지원

문제가 지속되면 다음 정보와 함께 문의하세요:
- 운영체제 정보
- PostgreSQL 버전
- Node.js 버전
- 오류 메시지 전문
- 실행한 명령어 
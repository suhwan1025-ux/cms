# 🎯 운영 환경 정정 기능 문제 - 최종 해결 방법

## 📋 문제 상황 정리

- ✅ DB에 `original_proposal_id`, `correction_reason` 컬럼 **있음**
- ✅ 서버 **재시작** 완료
- ❌ 정정 품의서 생성 시 DB에 값 **저장 안 됨**
- ❌ DB에 수기로 입력해도 프론트엔드에서 **로드 안 됨**

---

## 🔍 문제 원인

### **Sequelize 설정 충돌**

`src/models/Proposal.js`:
```javascript
// 필드 정의
originalProposalId: {
  field: 'original_proposal_id',  // ⚠️ snake_case 명시
}

// 모델 설정
{
  underscored: true  // ⚠️ 자동 snake_case 변환 활성화
}
```

**문제**:
- `underscored: true` → Sequelize가 자동으로 camelCase ↔ snake_case 변환
- `field: 'original_proposal_id'` → 명시적 field 지정
- **충돌**: `toJSON()` 시 snake_case로 반환되어 프론트엔드가 읽지 못함

---

## ✅ 적용한 해결 방법

### **서버에서 명시적 키 변환 추가**

#### 1. POST API (저장 후 확인) - `server.js` 라인 1975
```javascript
const proposal = await models.Proposal.create(createData);

// 🔍 저장 후 DB에서 다시 조회하여 실제 저장 확인
const savedProposal = await models.Proposal.findByPk(proposal.id);
const savedData = savedProposal.toJSON();
console.log('🔍 DB 저장 확인:', {
  originalProposalId: savedData.originalProposalId,
  original_proposal_id: savedData.original_proposal_id
});
```

#### 2. GET API 상세 조회 - `server.js` 라인 2452
```javascript
const proposalData = proposal.toJSON();

// 🔧 명시적 키 변환: snake_case → camelCase
if (proposalData.original_proposal_id !== undefined && 
    proposalData.originalProposalId === undefined) {
  proposalData.originalProposalId = proposalData.original_proposal_id;
}
if (proposalData.correction_reason !== undefined && 
    proposalData.correctionReason === undefined) {
  proposalData.correctionReason = proposalData.correction_reason;
}
```

#### 3. GET API 목록 조회 - `server.js` 라인 2363
```javascript
const proposalsWithBudget = await Promise.all(proposals.map(async (proposal) => {
  const proposalData = proposal.toJSON();
  
  // ... 예산 정보 등 추가 ...
  
  // 🔧 정정 관련 필드 키 변환
  if (proposalData.original_proposal_id !== undefined && 
      proposalData.originalProposalId === undefined) {
    proposalData.originalProposalId = proposalData.original_proposal_id;
  }
  if (proposalData.correction_reason !== undefined && 
      proposalData.correctionReason === undefined) {
    proposalData.correctionReason = proposalData.correction_reason;
  }
  
  return proposalData;
}));
```

---

## 🚀 배포 절차

### **운영 서버에서 실행**

```bash
# 1. 코드 업데이트
cd /path/to/CMS_NEW
git pull origin main

# 2. 파일 확인 (수정된 파일)
git log -1 --name-only

# 3. 서버 재시작
pm2 restart server

# 4. 로그 실시간 확인
pm2 logs server
```

---

## 🧪 테스트 방법

### **1단계: 정정 품의서 생성**

1. 웹 브라우저에서 운영 환경 접속
2. 기존 품의서 선택 → "정정" 버튼 클릭
3. 정정 사유 입력 후 "작성완료" 클릭

**예상 서버 로그**:
```
🔍 정정 관련 필드 확인: {
  originalProposalId: 123,
  correctionReason: '입력한 정정 사유',
  correctionReasonLength: 20
}
✅ 품의서 생성 성공: {
  id: 184,
  originalProposalId: 123,
  correctionReason: '있음'
}
🔍 DB 저장 확인:
  originalProposalId: 123  또는
  original_proposal_id: 123
```

### **2단계: DB 직접 확인**

```sql
-- 방금 생성한 품의서 확인
SELECT id, title, original_proposal_id, correction_reason, status
FROM proposals
ORDER BY id DESC
LIMIT 3;
```

**예상 결과**:
```
 id  |        title         | original_proposal_id | correction_reason | status
-----+----------------------+----------------------+-------------------+---------
 184 | [정정품의] ...       |                  123 | 입력한 정정 사유  | pending
```

### **3단계: 프론트엔드 조회 테스트**

1. 생성한 정정 품의서를 목록에서 클릭
2. **F12 → Console 탭** 확인

**예상 콘솔 로그**:
```javascript
🔍 API에서 받은 데이터:
  originalProposalId: 123
  correctionReason: '입력한 정정 사유'
```

3. 미리보기 창에서 다음 확인:
   - "원본 품의서 보기" 버튼 표시됨
   - 정정 사유가 표시됨
   - 원본 품의서와 비교 표시됨

### **4단계: 수기 입력 데이터 로드 테스트**

이미 DB에 수기로 입력한 데이터가 있다면:

1. 해당 품의서 ID를 URL에서 직접 조회:
   ```
   https://운영서버/contracts (목록에서 찾아서 클릭)
   ```

2. **F12 콘솔**에서 확인:
   ```javascript
   console.log('originalProposalId:', data.originalProposalId);
   console.log('correctionReason:', data.correctionReason);
   ```

3. 값이 표시되면 ✅ 성공

---

## 📂 수정된 파일 목록

### 핵심 파일
1. ✅ **`server.js`** - 3곳 수정
   - POST API 저장 확인 로그 추가
   - GET API 상세 조회 키 변환 추가
   - GET API 목록 조회 키 변환 추가

### 문서 파일
2. ✅ `정정기능_문제분석_결과.md` - 상세 분석
3. ✅ `정정기능_수정사항_요약.md` - 수정 요약
4. ✅ `운영환경_정정기능_최종_해결방법.md` - 이 파일

---

## ❓ 문제 지속 시 확인사항

### **Case 1: 저장은 되는데 로드가 안 됨**

서버 로그 확인:
```bash
pm2 logs server | grep "toJSON()"
```

예상 출력:
```
🔍 toJSON() 결과 키 확인:
  original_proposal_id (snake_case): 123  ← 이게 보이면 문제!
  originalProposalId (camelCase): undefined
✅ original_proposal_id → originalProposalId 변환 완료  ← 이게 보여야 함
```

**해결**: 코드가 제대로 배포되었는지 확인

```bash
# server.js 파일 수정 날짜 확인
ls -l server.js

# 최근 git commit 확인
git log -1 --oneline
```

### **Case 2: 저장도 안 됨**

프론트엔드 콘솔 로그 확인:
```
🔍 디버깅 - 정정 모드: true
🔍 디버깅 - 정정 사유: (값이 있어야 함)
🔍 디버깅 - 원본 품의서 ID: (숫자가 있어야 함)
```

**둘 다 `null` 또는 `undefined`이면**: 프론트엔드 문제
**값이 있는데 저장 안 되면**: 서버 문제

서버 로그 다시 확인:
```bash
pm2 logs server | grep "정정 관련 필드"
```

### **Case 3: 아무 로그도 안 나옴**

서버가 구버전 코드를 실행 중:

```bash
# 서버 완전 재시작
pm2 delete server
pm2 start server.js --name server

# 또는
pm2 restart server --update-env
```

---

## 📞 추가 지원 필요 시

다음 정보를 제공해주세요:

1. **서버 로그** (정정 품의서 생성 시도 시):
   ```bash
   pm2 logs server --lines 100 > server_logs.txt
   ```

2. **브라우저 콘솔 로그** (F12 → Console 전체 복사)

3. **DB 직접 조회 결과**:
   ```sql
   SELECT id, original_proposal_id, correction_reason
   FROM proposals
   WHERE id = (문제의_품의서_ID);
   ```

4. **GET API 직접 호출 결과**:
   ```bash
   curl http://운영서버:포트/api/proposals/(품의서ID) | jq .
   ```

---

## 🎉 성공 확인

모든 테스트가 통과하면:

✅ 정정 품의서 생성 시 DB에 값 저장됨
✅ GET API로 조회 시 camelCase로 반환됨
✅ 프론트엔드에서 정상 수신됨
✅ 미리보기에서 정정 정보 표시됨
✅ 원본 ↔ 정정 품의서 연결 작동함

**배포 성공!** 🎊


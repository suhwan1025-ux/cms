# 정정 기능 수정사항 요약

## 🔍 문제 원인

**Sequelize `underscored: true` 설정과 명시적 `field` 속성 충돌**

- 모델에서 `underscored: true` 설정으로 자동 snake_case 변환
- 동시에 `field: 'original_proposal_id'` 명시
- `toJSON()` 호출 시 **snake_case로 반환되는 문제 발생**
- 프론트엔드는 camelCase를 기대하므로 데이터 수신 실패

---

## ✅ 적용한 수정사항

### 1. **server.js - POST API (품의서 생성)**
- 라인 1965 이후: 저장 후 실제 DB 값 확인 로그 추가
- 저장된 데이터가 어떤 키 형식인지 확인 가능

### 2. **server.js - GET API (품의서 상세 조회)**
- 라인 2452 이후: `toJSON()` 후 키 형식 확인 로그 추가
- **명시적 키 변환 로직 추가**: snake_case → camelCase
  ```javascript
  if (proposalData.original_proposal_id !== undefined && proposalData.originalProposalId === undefined) {
    proposalData.originalProposalId = proposalData.original_proposal_id;
  }
  if (proposalData.correction_reason !== undefined && proposalData.correctionReason === undefined) {
    proposalData.correctionReason = proposalData.correction_reason;
  }
  ```

### 3. **server.js - GET API (품의서 목록 조회)**
- 라인 2340 이후: 각 품의서마다 키 변환 로직 추가
- 목록 조회 시에도 camelCase로 통일

---

## 📂 수정된 파일

1. ✅ `server.js` - API 응답 수정
2. ✅ `정정기능_문제분석_결과.md` - 상세 분석 문서
3. ✅ `정정기능_수정사항_요약.md` - 이 파일

---

## 🚀 배포 방법

### 운영 서버에서 실행:

```bash
# 1. 코드 업데이트
cd /path/to/CMS_NEW
git pull origin main

# 2. 서버 재시작
pm2 restart server

# 3. 로그 확인
pm2 logs server --lines 50
```

---

## 🧪 테스트 방법

### 1. 정정 품의서 생성
1. 기존 품의서에서 "정정" 버튼 클릭
2. 정정 사유 입력 후 작성완료
3. **서버 로그 확인**:
   ```
   🔍 정정 관련 필드 확인: { originalProposalId: 123, correctionReason: '...' }
   ✅ 품의서 생성 성공: { ... originalProposalId: 123, correctionReason: '있음' }
   🔍 DB 저장 확인: { originalProposalId: 123, ... }
   ```

### 2. 품의서 조회
1. 생성한 정정 품의서 클릭
2. **서버 로그 확인**:
   ```
   🔍 toJSON() 결과 키 확인:
     originalProposalId (camelCase): 123
     correctionReason (camelCase): '정정 사유 내용'
   ```
3. **브라우저 콘솔 확인**:
   ```
   🔍 API에서 받은 데이터:
     originalProposalId: 123
     correctionReason: '정정 사유 내용'
   ```

### 3. DB 직접 확인
```sql
SELECT id, title, original_proposal_id, correction_reason, status
FROM proposals
WHERE original_proposal_id IS NOT NULL
ORDER BY id DESC
LIMIT 5;
```

---

## 📋 관련 파일 리스트 (참고용)

### 서버 사이드
- `server.js` - 메인 API 서버 (수정됨 ✅)
- `src/models/Proposal.js` - Sequelize 모델 정의
- `migrations/20251205-add-original-proposal-id.js` - 마이그레이션
- `migrations/20251205-add-correction-reason.js` - 마이그레이션

### 클라이언트 사이드
- `src/components/ProposalForm.js` - 품의서 작성/수정 폼
- `src/components/ContractList.js` - 품의서 목록 및 상세 보기
- `src/utils/previewGenerator.js` - 미리보기 생성
- `src/utils/statusHelper.js` - 상태 라벨 헬퍼

---

## ⚠️ 예상 결과

### 수정 전 (문제 상황)
- 프론트엔드: `data.originalProposalId` → `undefined` ❌
- 프론트엔드: `data.original_proposal_id` → `123` (하지만 코드는 camelCase를 사용)
- 결과: 원본 품의서 ID를 찾지 못함

### 수정 후 (해결)
- 서버에서 snake_case → camelCase 변환
- 프론트엔드: `data.originalProposalId` → `123` ✅
- 프론트엔드: `data.correctionReason` → `'정정 사유'` ✅
- 결과: 정상 작동

---

## 🔮 향후 개선 방안

### 근본적 해결 (나중에 적용)

**방법 1: `src/models/Proposal.js` 수정**
```javascript
// field 속성 제거
originalProposalId: {
  type: DataTypes.INTEGER,
  allowNull: true,
  // field: 'original_proposal_id', // ❌ 제거
  comment: '원본 품의서 ID (정정된 경우)'
},
correctionReason: {
  type: DataTypes.TEXT,
  allowNull: true,
  // field: 'correction_reason', // ❌ 제거
  comment: '정정 사유'
}
```

이렇게 하면:
- `underscored: true`가 자동으로 DB snake_case ↔ JS camelCase 변환
- 서버 코드에서 명시적 변환 불필요
- 더 깔끔하고 일관된 코드

**적용 시기**: 충분한 테스트 후 다음 배포에 포함

---

## ✅ 체크리스트

배포 후 확인사항:

- [ ] 정정 품의서 생성 시 DB에 `original_proposal_id`, `correction_reason` 저장됨
- [ ] GET API로 조회 시 `originalProposalId`, `correctionReason` (camelCase) 반환됨
- [ ] 프론트엔드에서 `originalProposalId`, `correctionReason` 정상 수신
- [ ] 미리보기에서 "원본 품의서" 버튼 표시됨
- [ ] 원본 품의서에서 "정정 품의서" 버튼 표시됨
- [ ] 정정 사유가 미리보기에 표시됨


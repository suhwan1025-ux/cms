# ìš´ì˜ í™˜ê²½ ì •ì • ê¸°ëŠ¥ ì ê²€ ì²´í¬ë¦¬ìŠ¤íŠ¸

## ğŸš¨ ë¬¸ì œ: ìš´ì˜ í™˜ê²½ì—ì„œ original_proposal_id, correction_reason ì €ì¥ ì•ˆ ë¨

---

## âœ… 1ë‹¨ê³„: ìš´ì˜ DBì— ì»¬ëŸ¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸

### ë°©ë²• 1: psqlë¡œ ì§ì ‘ í™•ì¸
```bash
# ìš´ì˜ ì„œë²„ì— ì ‘ì† í›„
psql -U postgres -d contract_management

# SQL ì‹¤í–‰
\d proposals

# ë˜ëŠ”
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'proposals' 
AND column_name IN ('original_proposal_id', 'correction_reason');
```

### ì˜ˆìƒ ê²°ê³¼
```
column_name           | data_type | is_nullable
----------------------+-----------+-------------
original_proposal_id  | integer   | YES
correction_reason     | text      | YES
```

### âŒ ì»¬ëŸ¼ì´ ì—†ë‹¤ë©´?
â†’ **ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ í•„ìš”** (2ë‹¨ê³„ë¡œ)

---

## âœ… 2ë‹¨ê³„: ìš´ì˜ í™˜ê²½ì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

### ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ í™•ì¸
ìš´ì˜ ì„œë²„ì— ë‹¤ìŒ íŒŒì¼ë“¤ì´ ìˆëŠ”ì§€ í™•ì¸:
```
migrations/20251205-add-original-proposal-id.js
migrations/20251205-add-correction-reason.js
```

### ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ë°©ë²•

#### A. Sequelize CLI ì‚¬ìš© (ê¶Œì¥)
```bash
# ìš´ì˜ ì„œë²„ì—ì„œ
cd /path/to/CMS_NEW

# í”„ë¡œë•ì…˜ í™˜ê²½ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
NODE_ENV=production npx sequelize-cli db:migrate

# ë˜ëŠ”
npx sequelize-cli db:migrate --env production
```

#### B. ìˆ˜ë™ SQL ì‹¤í–‰
ë§Œì•½ Sequelize CLIê°€ ì—†ê±°ë‚˜ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤ë©´:

```sql
-- 1. original_proposal_id ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE proposals ADD COLUMN original_proposal_id INTEGER;
ALTER TABLE proposals ADD CONSTRAINT fk_proposals_original 
  FOREIGN KEY (original_proposal_id) REFERENCES proposals(id) 
  ON UPDATE CASCADE ON DELETE SET NULL;
COMMENT ON COLUMN proposals.original_proposal_id IS 'ì›ë³¸ í’ˆì˜ì„œ ID (ì •ì •ëœ ê²½ìš°)';

-- 2. correction_reason ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE proposals ADD COLUMN correction_reason TEXT;
COMMENT ON COLUMN proposals.correction_reason IS 'ì •ì • ì‚¬ìœ ';
```

#### C. Node.js ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
```bash
# ìš´ì˜ ì„œë²„ì—ì„œ
cd /path/to/CMS_NEW

# ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì§ì ‘ ì‹¤í–‰
node migrations/20251205-add-original-proposal-id.js
node migrations/20251205-add-correction-reason.js
```

---

## âœ… 3ë‹¨ê³„: ìš´ì˜ í™˜ê²½ ì½”ë“œ ë°°í¬ í™•ì¸

### í™•ì¸í•  íŒŒì¼ë“¤

#### server.js (ë¼ì¸ 1920-1970 ë¶€ê·¼)
```javascript
// ì´ ë¡œê·¸ê°€ ìˆëŠ”ì§€ í™•ì¸
console.log('ğŸ” ì •ì • ê´€ë ¨ í•„ë“œ í™•ì¸:', {
  originalProposalId: proposalData.originalProposalId,
  correctionReason: proposalData.correctionReason,
  correctionReasonLength: proposalData.correctionReason?.length
});

// createDataì— ì´ë ‡ê²Œ ë˜ì–´ìˆëŠ”ì§€ í™•ì¸
correctionReason: proposalData.correctionReason !== undefined ? proposalData.correctionReason : null,
originalProposalId: proposalData.originalProposalId !== undefined ? 
  (proposalData.originalProposalId ? parseInt(proposalData.originalProposalId) : null) : null
```

#### src/components/ProposalForm.js (ë¼ì¸ 3050 ë¶€ê·¼)
```javascript
// ì´ ë¡œê·¸ê°€ ìˆëŠ”ì§€ í™•ì¸
console.log('ğŸ” ë””ë²„ê¹… - ì •ì • ëª¨ë“œ:', isCorrectionMode);
console.log('ğŸ” ë””ë²„ê¹… - ì •ì • ì‚¬ìœ :', proposalData.correctionReason);
console.log('ğŸ” ë””ë²„ê¹… - ì›ë³¸ í’ˆì˜ì„œ ID:', proposalData.originalProposalId);
```

#### src/models/Proposal.js (ë¼ì¸ 181-192)
```javascript
originalProposalId: {
  type: DataTypes.INTEGER,
  allowNull: true,
  field: 'original_proposal_id',
  comment: 'ì›ë³¸ í’ˆì˜ì„œ ID (ì •ì •ëœ ê²½ìš°)'
},
correctionReason: {
  type: DataTypes.TEXT,
  allowNull: true,
  field: 'correction_reason',
  comment: 'ì •ì • ì‚¬ìœ '
}
```

---

## âœ… 4ë‹¨ê³„: ìš´ì˜ í™˜ê²½ ë°°í¬ ë°©ë²•

### Option A: Gitì„ í†µí•œ ë°°í¬
```bash
# ìš´ì˜ ì„œë²„ì—ì„œ
cd /path/to/CMS_NEW
git pull origin main

# npm íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ (í•„ìš”ì‹œ)
npm install

# React ë¹Œë“œ (í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°)
npm run build
```

### Option B: íŒŒì¼ ì§ì ‘ ë³µì‚¬
ê°œë°œ í™˜ê²½ì—ì„œ ìš´ì˜ í™˜ê²½ìœ¼ë¡œ ë‹¤ìŒ íŒŒì¼ë“¤ì„ ë³µì‚¬:
```
- server.js
- src/components/ProposalForm.js
- src/models/Proposal.js
- migrations/20251205-add-original-proposal-id.js
- migrations/20251205-add-correction-reason.js
```

### Option C: Docker ì‚¬ìš© ì¤‘ì´ë¼ë©´
```bash
# ì´ë¯¸ì§€ ë‹¤ì‹œ ë¹Œë“œ
docker-compose build

# ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
docker-compose down
docker-compose up -d
```

---

## âœ… 5ë‹¨ê³„: ì„œë¹„ìŠ¤ ì¬ì‹œì‘

### PM2 ì‚¬ìš© ì¤‘
```bash
pm2 restart server
# ë˜ëŠ”
pm2 restart all
```

### systemd ì‚¬ìš© ì¤‘
```bash
sudo systemctl restart cms-server
```

### ì§ì ‘ ì‹¤í–‰ ì¤‘
```bash
# ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
pkill -f "node.*server"

# ìƒˆë¡œ ì‹œì‘
NODE_ENV=production node server.js
# ë˜ëŠ”
NODE_ENV=production node server.prod.js
```

---

## âœ… 6ë‹¨ê³„: ë°°í¬ í›„ í…ŒìŠ¤íŠ¸

### 1. ì„œë²„ ë¡œê·¸ í™•ì¸
```bash
# PM2 ì‚¬ìš© ì‹œ
pm2 logs server

# ë¡œê·¸ íŒŒì¼ ì§ì ‘ í™•ì¸
tail -f logs/server.log

# Docker ì‚¬ìš© ì‹œ
docker-compose logs -f
```

**ì°¾ì•„ì•¼ í•  ë¡œê·¸:**
```
ğŸ” ì •ì • ê´€ë ¨ í•„ë“œ í™•ì¸: { originalProposalId: 123, correctionReason: '...', ... }
âœ… í’ˆì˜ì„œ ìƒì„± ì„±ê³µ: { ... originalProposalId: 123, correctionReason: 'ìˆìŒ' }
```

### 2. ë¸Œë¼ìš°ì €ì—ì„œ í…ŒìŠ¤íŠ¸
1. ìš´ì˜ í™˜ê²½ ì ‘ì†
2. ê¸°ì¡´ í’ˆì˜ì„œì—ì„œ "ì •ì •" ë²„íŠ¼ í´ë¦­
3. **F12 â†’ Console íƒ­** ì—´ê¸°
4. ì •ì • ì‚¬ìœ  ì…ë ¥ í›„ ì‘ì„±ì™„ë£Œ

**ì°¾ì•„ì•¼ í•  ì½˜ì†” ë¡œê·¸:**
```
ğŸ” ë””ë²„ê¹… - ì •ì • ëª¨ë“œ: true
ğŸ” ë””ë²„ê¹… - ì •ì • ì‚¬ìœ : (ì…ë ¥í•œ ë‚´ìš©)
ğŸ” ë””ë²„ê¹… - ì›ë³¸ í’ˆì˜ì„œ ID: 123
```

### 3. ë°ì´í„°ë² ì´ìŠ¤ ì§ì ‘ í™•ì¸
```sql
-- ë°©ê¸ˆ ìƒì„±í•œ í’ˆì˜ì„œ í™•ì¸
SELECT id, title, original_proposal_id, correction_reason, status, created_at
FROM proposals
ORDER BY id DESC
LIMIT 3;
```

---

## ğŸ” ë¬¸ì œ ì§„ë‹¨ í”Œë¡œìš°ì°¨íŠ¸

```
ìš´ì˜ í™˜ê²½ì—ì„œ ì •ì • ë°ì´í„° ì €ì¥ ì•ˆ ë¨
    â†“
1. DBì— ì»¬ëŸ¼ì´ ìˆëŠ”ê°€?
   NO â†’ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ (2ë‹¨ê³„)
   YES â†“
    
2. ì„œë²„ ì½”ë“œê°€ ìµœì‹ ì¸ê°€? (server.jsì— ë¡œê·¸ ìˆëŠ”ê°€?)
   NO â†’ ì½”ë“œ ë°°í¬ (4ë‹¨ê³„)
   YES â†“
    
3. í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œê°€ ìµœì‹ ì¸ê°€?
   NO â†’ npm run build í›„ ì¬ë°°í¬
   YES â†“
    
4. ì„œë²„ê°€ ì¬ì‹œì‘ë˜ì—ˆëŠ”ê°€?
   NO â†’ ì„œë²„ ì¬ì‹œì‘ (5ë‹¨ê³„)
   YES â†“
    
5. ì„œë²„ ë¡œê·¸ì— ì •ì • ê´€ë ¨ ë¡œê·¸ê°€ ë³´ì´ëŠ”ê°€?
   NO â†’ ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ë˜ëŠ” í”„ë¡ íŠ¸ì—”ë“œ ë¯¸ë°°í¬
   YES â†“
    
6. DBì— ì‹¤ì œë¡œ ì €ì¥ë˜ëŠ”ê°€?
   NO â†’ DB ê¶Œí•œ ë¬¸ì œ ë˜ëŠ” íŠ¸ëœì­ì…˜ ë¡¤ë°± í™•ì¸
   YES â†’ âœ… í•´ê²°!
```

---

## ğŸš€ ë¹ ë¥¸ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸

ìš´ì˜ ì„œë²„ì— ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë§Œë“¤ì–´ ì‹¤í–‰:

```bash
#!/bin/bash
# deploy-correction-fix.sh

echo "=== ìš´ì˜ í™˜ê²½ ì •ì • ê¸°ëŠ¥ ë°°í¬ ì‹œì‘ ==="

# 1. ì½”ë“œ ì—…ë°ì´íŠ¸
echo "1. ì½”ë“œ ì—…ë°ì´íŠ¸..."
cd /path/to/CMS_NEW
git pull origin main

# 2. ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
echo "2. ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰..."
NODE_ENV=production npx sequelize-cli db:migrate

# 3. í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ (ì„ íƒì‚¬í•­)
# echo "3. í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ..."
# npm run build

# 4. ì„œë²„ ì¬ì‹œì‘
echo "4. ì„œë²„ ì¬ì‹œì‘..."
pm2 restart server

# 5. ë¡œê·¸ í™•ì¸
echo "5. ì„œë²„ ë¡œê·¸ í™•ì¸ (Ctrl+Cë¡œ ì¢…ë£Œ)..."
sleep 3
pm2 logs server
```

ì‹¤í–‰:
```bash
chmod +x deploy-correction-fix.sh
./deploy-correction-fix.sh
```

---

## ğŸ“ ì¶”ê°€ ì§€ì›ì´ í•„ìš”í•œ ê²½ìš°

ë‹¤ìŒ ì •ë³´ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”:
1. ìš´ì˜ í™˜ê²½ì˜ DB ì»¬ëŸ¼ í™•ì¸ ê²°ê³¼ (`\d proposals`)
2. ìš´ì˜ ì„œë²„ì˜ server.js íŒŒì¼ ë‚ ì§œ/ë²„ì „
3. ì„œë²„ ë¡œê·¸ (ì •ì • í’ˆì˜ì„œ ìƒì„± ì‹œë„ ì‹œ)
4. ë¸Œë¼ìš°ì € ì½˜ì†” ë¡œê·¸ (ì •ì • í’ˆì˜ì„œ ì‘ì„± ì‹œ)

